<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Meine To-Do-Liste</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React + ReactDOM (UMD) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Babel für JSX im Browser -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Deine Firebase-Config (muss im Repo-Root liegen) -->
  <script src="firebase-config.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
    body { font-family: 'Inter', sans-serif; }
  </style>

  <!-- Firebase SDK (ES-Module); wir hängen benötigte Funktionen an window.firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, collection, addDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    window.firebase = {
      initializeApp,
      getAuth,
      signInAnonymously,
      signInWithCustomToken,
      onAuthStateChanged,
      getFirestore,
      doc,
      collection,
      addDoc,
      setDoc,
      onSnapshot
    };
  </script>
</head>
<body class="bg-gray-900">
  <div id="root"></div>

  <!-- Deine App -->
  <script type="text/babel">
    const { useState, useEffect } = React;
    const {
      initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
      getFirestore, doc, collection, addDoc, setDoc, onSnapshot
    } = window.firebase;

    // Globale Variablen aus firebase-config.js
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : undefined;

    // Firebase initialisieren
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const categories = ['Alle', 'Arbeit', 'Zuhause', 'Freizeit', 'Administratives'];
    const categoryColors = {
      'Arbeit': 'bg-blue-500',
      'Zuhause': 'bg-emerald-500',
      'Freizeit': 'bg-purple-500',
      'Administratives': 'bg-red-500',
      'Default': 'bg-gray-500',
    };

    const ToDoApp = () => {
      const [tasks, setTasks] = useState([]);
      const [newTaskText, setNewTaskText] = useState('');
      const [isModalVisible, setModalVisible] = useState(false);
      const [selectedTask, setSelectedTask] = useState(null);
      const [dueDate, setDueDate] = useState('');
      const [newCategory, setNewCategory] = useState('Arbeit');
      const [selectedCategoryFilter, setSelectedCategoryFilter] = useState('Alle');
      const [userId, setUserId] = useState(null);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);

      // Auth einrichten
      useEffect(() => {
        const initializeFirebaseAuth = async () => {
          try {
            await (initialAuthToken
              ? signInWithCustomToken(auth, initialAuthToken)
              : signInAnonymously(auth));
          } catch (e) {
            console.error("Firebase auth error:", e);
            setError("Fehler bei der Firebase-Authentifizierung.");
          }
        };

        const unsubscribe = onAuthStateChanged(auth, (user) => {
          setUserId(user ? user.uid : null);
          setLoading(false);
        });

        initializeFirebaseAuth();
        return () => unsubscribe();
      }, []);

      // Firestore-Listener
      useEffect(() => {
        if (!userId) return;
        const tasksCollectionPath = \`artifacts/\${appId}/users/\${userId}/tasks\`;
        const q = collection(db, tasksCollectionPath);

        const unsubscribe = onSnapshot(q, (querySnapshot) => {
          const todos = [];
          querySnapshot.forEach((docSnap) => {
            todos.push({ id: docSnap.id, ...docSnap.data() });
          });
          todos.sort((a, b) => (a.priority ?? 0) - (b.priority ?? 0));
          setTasks(todos);
        }, (e) => {
          console.error("Error fetching tasks:", e);
          setError("Aufgaben konnten nicht geladen werden.");
        });

        return () => unsubscribe();
      }, [userId]);

      const addTask = async () => {
        if (!newTaskText.trim()) return;
        if (!userId) { setError("Firebase ist noch nicht bereit."); return; }

        try {
          const priority = tasks.length > 0 ? (tasks[tasks.length - 1].priority ?? tasks.length) + 1 : 0;
          const newTask = {
            text: newTaskText,
            priority,
            category: newCategory,
            isCompleted: false,
            dueDate: dueDate || null,
            createdAt: new Date().toISOString(),
          };
          const tasksCollection = collection(db, \`artifacts/\${appId}/users/\${userId}/tasks\`);
          await addDoc(tasksCollection, newTask);
          setNewTaskText('');
          setDueDate('');
          setNewCategory('Arbeit');
        } catch (e) {
          console.error("Error adding task:", e);
          setError("Aufgabe konnte nicht hinzugefügt werden.");
        }
      };

      const moveTask = async (taskId, direction) => {
        if (!userId) { setError("Firebase ist noch nicht bereit."); return; }
        const taskIndex = tasks.findIndex(t => t.id === taskId);
        if (taskIndex === -1) return;

        const newIndex = taskIndex + (direction === 'up' ? -1 : 1);
        if (newIndex < 0 || newIndex >= tasks.length) return;

        const taskToMove = tasks[taskIndex];
        const taskToSwap = tasks[newIndex];

        const docRef1 = doc(db, \`artifacts/\${appId}/users/\${userId}/tasks/\${taskToMove.id}\`);
        const docRef2 = doc(db, \`artifacts/\${appId}/users/\${userId}/tasks/\${taskToSwap.id}\`);

        try {
          await setDoc(docRef1, { ...taskToMove, priority: newIndex });
          await setDoc(docRef2, { ...taskToSwap, priority: taskIndex });
        } catch (e) {
          console.error("Error reordering tasks:", e);
          setError("Priorität konnte nicht geändert werden.");
        }
      };

      const openEditModal = (task) => {
        setSelectedTask(task);
        setDueDate(task.dueDate || '');
        setModalVisible(true);
      };

      const saveTaskChanges = async () => {
        if (!selectedTask) return;
        if (!userId) { setError("Firebase ist noch nicht bereit."); return; }

        try {
          const taskDocRef = doc(db, \`artifacts/\${appId}/users/\${userId}/tasks/\${selectedTask.id}\`);
          await setDoc(taskDocRef, { ...selectedTask, dueDate }, { merge: true });
          setModalVisible(false);
          setSelectedTask(null);
        } catch (e) {
          console.error("Error saving changes:", e);
          setError("Änderungen konnten nicht gespeichert werden.");
        }
      };

      const filteredTasks = tasks.filter(task =>
        selectedCategoryFilter === 'Alle' || task.category === selectedCategoryFilter
      );

      return (
        <div className="min-h-screen bg-gray-900

