<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Meine To-Do-Liste</title>

  <!-- Tailwind + React + Babel (mit CORS für bessere Fehler) -->
  <script src="https://cdn.tailwindcss.com" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js" crossorigin="anonymous"></script>

  <!-- Deine Firebase-Config MUSS vor den Imports kommen -->
  <script src="firebase-config.js"></script>

  <!-- Firebase v10 (ES Modules) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { getFirestore, doc, collection, addDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    window.firebase = {
      initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
      getFirestore, doc, collection, addDoc, setDoc, onSnapshot
    };
  </script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
    body { font-family: 'Inter', sans-serif; }
  </style>
</head>
<body class="bg-gray-900">
  <div id="root"></div>

  <!-- Verbessertes Fehler-Overlay (zeigt Stacktrace & Quelle) -->
  <script>
    (function () {
      const box = document.createElement('div');
      Object.assign(box.style, {
        position:'fixed',left:'8px',bottom:'8px',maxWidth:'92vw',zIndex:99999,
        background:'rgba(0,0,0,.85)',color:'#fff',padding:'10px 12px',
        font:'12px/1.4 system-ui,-apple-system,Segoe UI,Roboto,sans-serif',
        borderRadius:'8px',whiteSpace:'pre-wrap',display:'none'
      });
      document.addEventListener('DOMContentLoaded',()=>document.body.appendChild(box));
      function show(msg){ box.style.display='block'; box.textContent = msg; console.error(msg); }
      window.addEventListener('error', e => {
        const stack = e.error && e.error.stack ? '\n' + e.error.stack : '';
        show('Fehler: ' + e.message + (e.filename?`\nQuelle: ${e.filename}:${e.lineno}:${e.colno}`:'') + stack);
      });
      window.addEventListener('unhandledrejection', e => {
        const r = e.reason || {};
        const msg = r.message || String(e.reason);
        const stack = r.stack ? '\n' + r.stack : '';
        show('Promise-Rejection: ' + msg + stack);
      });
    })();
  </script>

  <!-- App (JSX via Babel) -->
  <script type="text/babel">
    try {
      const { useState, useEffect } = React;

      // Guard: firebase-config.js geladen?
      if (typeof __firebase_config === 'undefined') {
        document.getElementById('root').innerHTML =
          '<div style="padding:16px;color:#fff">Fehler: <code>firebase-config.js</code> wurde nicht geladen. ' +
          'Lege die Datei ins Repo-Root und binde sie im &lt;head&gt; via ' +
          '<code>&lt;script src="firebase-config.js"&gt;&lt;/script&gt;</code> ein.</div>';
      } else {
        const {
          initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
          getFirestore, doc, collection, addDoc, setDoc, onSnapshot
        } = window.firebase;

        const firebaseConfig = JSON.parse(__firebase_config);
        const appId = (typeof __app_id !== 'undefined') ? __app_id : 'pads-to-do';
        const initialAuthToken = (typeof __initial_auth_token !== 'undefined') ? __initial_auth_token : undefined;

        // Firebase init
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const categories = ['Alle', 'Arbeit', 'Zuhause', 'Freizeit', 'Administratives'];
        const categoryColors = {
          'Arbeit': 'bg-blue-500','Zuhause': 'bg-emerald-500','Freizeit': 'bg-purple-500','Administratives': 'bg-red-500','Default': 'bg-gray-500',
        };

        const ToDoApp = () => {
          const [tasks, setTasks] = useState([]);
          const [newTaskText, setNewTaskText] = useState('');
          const [isModalVisible, setModalVisible] = useState(false);
          const [selectedTask, setSelectedTask] = useState(null);
          const [dueDate, setDueDate] = useState('');
          const [newCategory, setNewCategory] = useState('Arbeit');
          const [selectedCategoryFilter, setSelectedCategoryFilter] = useState('Alle');
          const [userId, setUserId] = useState(null);
          const [loading, setLoading] = useState(true);
          const [error, setError] = useState(null);

          // Auth
          useEffect(() => {
            const initAuth = async () => {
              try {
                await (initialAuthToken ? signInWithCustomToken(auth, initialAuthToken) : signInAnonymously(auth));
              } catch (e) {
                console.error("Firebase auth error:", e);
                setError("Fehler bei der Firebase-Authentifizierung.");
              }
            };
            const unsub = onAuthStateChanged(auth, user => {
              setUserId(user ? user.uid : null);
              setLoading(false);
            });
            initAuth();
            return () => unsub();
          }, []);

          // Daten laden
          useEffect(() => {
            if (!userId) return;
            const path = `artifacts/${appId}/users/${userId}/tasks`;
            const q = collection(db, path);
            const unsub = onSnapshot(q, qs => {
              const todos = [];
              qs.forEach(docSnap => todos.push({ id: docSnap.id, ...docSnap.data() }));
              todos.sort((a,b) => (a.priority ?? 0) - (b.priority ?? 0));
              setTasks(todos);
            }, e => {
              console.error("Error fetching tasks:", e);
              setError("Aufgaben konnten nicht geladen werden.");
            });
            return () => unsub();
          }, [userId]);

          const addTask = async () => {
            if (!newTaskText.trim()) return;
            if (!userId) { setError("Firebase ist noch nicht bereit."); return; }
            try {
              const priority = tasks.length > 0 ? ((tasks[tasks.length - 1].priority ?? tasks.length) + 1) : 0;
              const newTask = { text:newTaskText, priority, category:newCategory, isCompleted:false, dueDate: dueDate || null, createdAt:new Date().toISOString() };
              await addDoc(collection(db, `artifacts/${appId}/users/${userId}/tasks`), newTask);
              setNewTaskText(''); setDueDate(''); setNewCategory('Arbeit');
            } catch (e) {
              console.error("Error adding task:", e);
              setError("Aufgabe konnte nicht hinzugefügt werden.");
            }
          };

          const moveTask = async (taskId, direction) => {
            if (!userId) { setError("Firebase ist noch nicht bereit."); return; }
            const idx = tasks.findIndex(t => t.id === taskId);
            if (idx === -1) return;
            const newIdx = idx + (direction === 'up' ? -1 : 1);
            if (newIdx < 0 || newIdx >= tasks.length) return;

            const a = tasks[idx], b = tasks[newIdx];
            try {
              await setDoc(doc(db, `artifacts/${appId}/users/${userId}/tasks/${a.id}`), { ...a, priority: newIdx });
              await setDoc(doc(db, `artifacts/${appId}/users/${userId}/tasks/${b.id}`), { ...b, priority: idx });
            } catch (e) {
              console.error("Error reordering tasks:", e);
              setError("Priorität konnte nicht geändert werden.");
            }
          };

          const openEditModal = (task) => { setSelectedTask(task); setDueDate(task.dueDate || ''); setModalVisible(true); };
          const saveTaskChanges = async () => {
            if (!selectedTask) return;
            if (!userId) { setError("Firebase ist noch nicht bereit."); return; }
            try {
              await setDoc(doc(db, `artifacts/${appId}/users/${userId}/tasks/${selectedTask.id}`), { ...selectedTask, dueDate }, { merge: true });
              setModalVisible(false); setSelectedTask(null);
            } catch (e) {
              console.error("Error saving changes:", e);
              setError("Änderungen konnten nicht gespeichert werden.");
            }
          };

          const filteredTasks = tasks.filter(t => selectedCategoryFilter === 'Alle' || t.category === selectedCategoryFilter);

          return (
            <div className="min-h-screen bg-gray-900 text-white p-4">
              <div className="absolute inset-0 bg-gradient-to-br from-yellow-400 to-fuchsia-600"></div>
              <div className="relative z-10 max-w-2xl mx-auto">
                {loading ? (
                  <div className="flex justify-center items-center h-screen"><p className="text-xl">App wird geladen...</p></div>
                ) : error ? (
                  <div className="flex justify-center items-center h-screen"><p className="text-xl text-red-200">{error}</p></div>
                ) : (
                  <>
                    <header className="p-5 text-center">
                      <h1 className="text-4xl font-extrabold tracking-wide mb-2">Meine To-Do-Liste</h1>
                      <p className="text-xs text-white/70">Benutzer-ID: {userId}</p>
                    </header>

                    <div className="flex flex-col sm:flex-row gap-4 mb-4">
                      <input
                        type="text"
                        className="flex-1 bg-white/20 rounded-full px-6 py-3 text-lg text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-fuchsia-400"
                        placeholder="Neue Aufgabe hinzufügen..."
                        value={newTaskText}
                        onChange={(e) => setNewTaskText(e.target.value)}
                      />
                      <select
                        className="bg-white/20 rounded-full px-6 py-3 text-white focus:outline-none focus:ring-2 focus:ring-fuchsia-400"
                        value={newCategory}
                        onChange={(e) => setNewCategory(e.target.value)}
                      >
                        {categories.slice(1).map(cat => (
                          <option key={cat} value={cat} className="bg-gray-800 text-white">{cat}</option>
                        ))}
                      </select>
                      <button
                        onClick={addTask}
                        className="bg-fuchsia-600 hover:bg-fuchsia-500 text-white text-2xl font-bold rounded-full w-14 h-14 flex items-center justify-center transition duration-200 shadow-lg"
                      >+</button>
                    </div>

                    <div className="flex flex-wrap gap-2 mb-8">
                      {categories.map(cat => (
                        <button
                          key={cat}
                          onClick={() => setSelectedCategoryFilter(cat)}
                          className={`px-4 py-2 rounded-full text-sm font-semibold transition duration-200 ${
                            selectedCategoryFilter === cat ? 'bg-white text-gray-900 shadow-inner' : 'bg-white/20 text-white hover:bg-white/30'
                          }`}
                        >{cat}</button>
                      ))}
                    </div>

                    <div className="space-y-4">
                      {filteredTasks.map(item => (
                        <div key={item.id} className="flex items-center bg-white/15 rounded-xl p-4 shadow-lg">
                          <div className="flex-1 cursor-pointer" onClick={() => { setSelectedTask(item); setDueDate(item.dueDate || ''); setModalVisible(true); }}>
                            <p className="text-lg font-semibold text-white">{item.text}</p>
                            <span className={`inline-block mt-2 px-3 py-1 text-xs font-bold text-white rounded-full ${categoryColors[item.category] || categoryColors['Default']}`}>
                              {item.category}
                            </span>
                            {item.dueDate && <p className="text-sm text-white/70 mt-1">Fällig: {new Date(item.dueDate).toLocaleDateString()}</p>}
                          </div>
                          <div className="flex flex-row ml-4 space-x-2">
                            <button onClick={() => moveTask(item.id, 'up')} className="bg-white/20 rounded-md w-8 h-8 flex items-center justify-center transition duration-200 hover:bg-white/30">
                              <span className="text-white text-xl">▲</span>
                            </button>
                            <button onClick={() => moveTask(item.id, 'down')} className="bg-white/20 rounded-md w-8 h-8 flex items-center justify-center transition duration-200 hover:bg-white/30">
                              <span className="text-white text-xl">▼</span>
                            </button>
                          </div>
                        </div>
                      ))}
                    </div>

                    {isModalVisible && selectedTask && (
                      <div className="fixed inset-0 flex items-center justify-center bg-black/50 z-50 p-4">
                        <div className="bg-white rounded-2xl p-8 max-w-sm w-full text-center shadow-2xl">
                          <h2 className="text-2xl font-bold text-gray-800 mb-4">Aufgabe bearbeiten</h2>
                          <p className="text-lg text-gray-600 mb-4">{selectedTask.text}</p>
                          <input
                            type="text"
                            className="w-full bg-gray-100 rounded-lg px-4 py-3 mb-4 text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-fuchsia-400"
                            placeholder="Fälligkeitsdatum (z.B. 2025-08-09)"
                            value={dueDate}
                            onChange={(e) => setDueDate(e.target.value)}
                          />
                          <div className="flex gap-4 mt-4">
                            <button onClick={saveTaskChanges} className="flex-1 bg-fuchsia-600 hover:bg-fuchsia-500 text-white font-bold py-3 rounded-xl transition duration-200 shadow-md">Speichern</button>
                            <button onClick={() => { setModalVisible(false); setSelectedTask(null); }} className="flex-1 bg-gray-400 hover:bg-gray-500 text-white font-bold py-3 rounded-xl transition duration-200 shadow-md">Abbrechen</button>
                          </div>
                        </div>
                      </div>
                    )}
                  </>
                )}
              </div>
            </div>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(ToDoApp));
      }
    } catch (err) {
      const box = document.createElement('pre');
      box.style = 'position:fixed;left:8px;bottom:8px;max-width:92vw;z-index:99999;background:rgba(0,0,0,.85);color:#fff;padding:10px 12px;border-radius:8px;white-space:pre-wrap;';
      box.textContent = 'Initialisierungsfehler:\n' + (err && err.stack ? err.stack : String(err));
      document.body.appendChild(box);
      throw err;
    }
  </script>
</body>
</html>
