<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Meine To-Do-Liste</title>

  <!-- Tailwind + React + Babel (mit CORS f체r bessere Fehler) -->
  <script src="https://cdn.tailwindcss.com" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js" crossorigin="anonymous"></script>

  <!-- Deine Firebase-Config MUSS vor den Imports kommen -->
  <script src="firebase-config.js"></script>

  <!-- Firebase v10 (ES Modules) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { getFirestore, doc, collection, addDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    window.firebase = {
      initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
      getFirestore, doc, collection, addDoc, setDoc, onSnapshot
    };
  </script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
    body { font-family: 'Inter', sans-serif; }
  </style>
</head>
<body class="bg-gray-900">
  <div id="root"></div>

  <!-- Verbessertes Fehler-Overlay (zeigt Stacktrace & Quelle) -->
  <script>
    (function () {
      const box = document.createElement('div');
      Object.assign(box.style, {
        position:'fixed',left:'8px',bottom:'8px',maxWidth:'92vw',zIndex:99999,
        background:'rgba(0,0,0,.85)',color:'#fff',padding:'10px 12px',
        font:'12px/1.4 system-ui,-apple-system,Segoe UI,Roboto,sans-serif',
        borderRadius:'8px',whiteSpace:'pre-wrap',display:'none'
      });
      document.addEventListener('DOMContentLoaded',()=>document.body.appendChild(box));
      function show(msg){ box.style.display='block'; box.textContent = msg; console.error(msg); }
      window.addEventListener('error', e => {
        const stack = e.error && e.error.stack ? '\n' + e.error.stack : '';
        show('Fehler: ' + e.message + (e.filename?`\nQuelle: ${e.filename}:${e.lineno}:${e.colno}`:'') + stack);
      });
      window.addEventListener('unhandledrejection', e => {
        const r = e.reason || {};
        const msg = r.message || String(e.reason);
        const stack = r.stack ? '\n' + r.stack : '';
        show('Promise-Rejection: ' + msg + stack);
      });
    })();
  </script>

  <!-- App (JSX via Babel) -->
  <script type="text/babel">
    try {
      const { useState, useEffect } = React;

      // Guard: firebase-config.js geladen?
      if (typeof __firebase_config === 'undefined') {
        document.getElementById('root').innerHTML =
          '<div style="padding:16px;color:#fff">Fehler: <code>firebase-config.js</code> wurde nicht geladen. ' +
          'Lege die Datei ins Repo-Root und binde sie im &lt;head&gt; via ' +
          '<code>&lt;script src="firebase-config.js"&gt;&lt;/script&gt;</code> ein.</div>';
      } else {
        const {
          initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
          getFirestore, doc, collection, addDoc, setDoc, onSnapshot
        } = window.firebase;

        const firebaseConfig = JSON.parse(__firebase_config);
        const appId = (typeof __app_id !== 'undefined') ? __app_id : 'pads-to-do';
        const initialAuthToken = (typeof __initial_auth_token !== 'undefined') ? __initial_auth_token : undefined;

        // Firebase init
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const categories = ['Alle', 'Arbeit', 'Zuhause', 'Freizeit', 'Administratives'];
        const categoryColors = {
          'Arbeit': 'bg-blue-500','Zuhause': 'bg-emerald-500','Freizeit': 'bg-purple-500','Administratives': 'bg-red-500','Default': 'bg-gray-500',
        };

        const ToDoApp = () => {
          const [tasks, setTasks] = useState([]);
          const [newTaskText, setNewTaskText] = useState('');
          const [isModalVisible, setModalVisible] = useState(false);
          const [selectedTask, setSelectedTask] = useState(null);
          const [dueDate, setDueDate] = useState('');
          const [newCategory, setNewCategory] = useState('Arbeit');
          const [selectedCategoryFilter, setSelectedCategoryFilter] = useState('Alle');
          const [userId, setUserId] = useState(null);
          const [loading, setLoading] = useState(true);
          const [error, setError] = useState(null);

          // Auth
          useEffect(() => {
            const initAuth = async () => {
              try {
                await (initialAuthToken ? signInWithCustomToken(auth, initialAuthToken) : signInAnonymously(auth));
              } catch (e) {
                console.error("Firebase auth error:", e);
                setError("Fehler bei der Firebase-Authentifizierung.");
              }
            };
            const unsub = onAuthStateChanged(auth, user => {
              setUserId(user ? user.uid : null);
              setLoading(false);
            });
            initAuth();
            return () => unsub();
          }, []);

          // Daten laden
          useEffect(() => {
            if (!userId) return;
            const path = `artifacts/${appId}/users/${userId}/tasks`;
            const q = collection(db, path);
            const unsub = onSnapshot(q, qs => {
              const todos = [];
              qs.forEach(docSnap => todos.push({ id: docSnap.id, ...docSnap.data() }));
              todos.sort((a,b) => (a.priority ?? 0) - (b.priority ?? 0));
              setTasks(todos);
            }, e => {
              console.error("Error fetching tasks:", e);
              setError("Aufgaben konnten nicht geladen werden.");
            });
            return () => unsub();
          }, [userId]);

          const addTask = async () => {
            if (!newTaskText.trim()) return;
            if (!userId) { setError("Firebase ist noch nicht bereit."); return; }
            try {
              const priority = tasks.length > 0 ? ((tasks[tasks.length - 1].priority ?? tasks.length) + 1) : 0;
              const newTask = { text:newTaskText, priority, category:newCategory, isCompleted:false, dueDate: dueDate || null, createdAt:new Date().toISOString() };
              await addDoc(collection(db, `artifacts/${appId}/users/${userId}/tasks`), newTask);
              setNewTaskText(''); setDueDate(''); setNewCategory('Arbeit');
            } catch (e) {
              console.error("Error adding task:", e);
              setError("Aufgabe konnte nicht hinzugef체gt werden.");
            }
          };

          const moveTask = async (taskId, direction) => {
            if (!userId) { setError("Firebase ist noch nicht bereit."); return; }
            const idx = tasks.findIndex(t => t.id === taskId);
            if (idx === -1) return;
            const newIdx = idx + (direction === 'up' ? -1 : 1);
            if (newIdx < 0 || newIdx >= tasks.length) return;

            const a = tasks[idx], b = tasks[newIdx];
            try {
              await setDoc(doc(db, `artifacts/${appId}/users/${userId}/tasks/${a.id}`), { ...a, priority: newIdx });
              await setDoc(doc(db, `artifacts/${appId}/users/${userId}/tasks/${b.id}`), { ...b, priority: idx });
            } catch (e) {
              console.error("Error reordering tasks:", e);
              setError("Priorit채t konnte nicht ge채ndert werden.");
            }
          };

          const openEditModal = (tas
